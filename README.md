# Welcome to West's MSF (Mission Scripting Framework)!
MSF is similar to MOOSE in many ways, but it designed to be smaller, more collaborative, and has improved networking
functions. It retains very similar O-O wrappers for DCS objects and event handling. Modules like Persist are not 
included, but instead can be added externally through MSF GitHub functions through the command line. MSF also sets up an
organized project structure for you to aid in mission development. Currently, MSF is not compatible with MOOSE.

# Requirements

1. [Git](https://git-scm.com/downloads), For command-line functions.
2. Curl, This should be included in your window's installation if you are using Windows 10 or 11. If not, you can get it
from [here](https://curl.se/windows/). Make sure to add to your path.

# Installation

## Create a Fork (Highly Recommended)
I recommend creating a fork of MSF, so you can track your user script files. If this is your own organization's
repository, skip this step.

To do this:

1. On the repository page on GitHub, click the fork button on the top right.
2. Adjust owner as necessary and name the repository whatever you want.
3. If you want, change the description and unselect `Copy the main branch only` if you want to use newer features.
4. Click `Create Fork`.

## Clone Your Repository (Mandatory)
1. If you are unfamiliar with Git, I recommend learning basics before continuing to use MSF.
2. You can use command line or download the code directly from GitHub.
3. Clone the repository into any directory you like.

## Lua 5.1.5 64 bit (Highly Recommended)
Lua 5.1.5 is included and is only needed to run MSF from the command line to add, remove, and update repositories.
This is the same version that DCS uses, but in theory you could use a newer version. Simply add to your path, the
location of the Lua folder included with this installation.

1. Go to your Environment Variable settings and add `[PathToYourRepository]\Lua` to `Path`

   ![Path example](https://gcdnb.pbrd.co/images/G87jKoZpGUcF.png?o=1)

**You only need to do this once!**

## Sym-linking (Highly Recommended)
Source control is made easier with sym-linking. Files will automatically be linked to your DCS Scripts folder and
tracked with git. The mission initialization script (`MSF.lua`) will dynamically add your scripts for you. You can 
instead work out of your script's folder should you wish.

1. Download and install [Link Shell Extension](https://schinagl.priv.at/nt/hardlinkshellext/linkshellextension.html)
2. Restart explorer if necessary.
3. Right-click your repository directory and select *Pick Link Source*
4. Navigate to `[username]\Saved Games\[DCS.[version]\Scripts`
5. Right-click and select *Drop As..* > *Symbolic Link*
6. Rename the dropped link directory as anything your would like, preferably the same name as your repository.

## Adding Appropriate Triggers to Mission (Mandatory)
**The order of triggers is very important!**
Note: You cannot use the initialization script function for this. Make sure to replace `[YourRepository]` with the
correct path.

1. Go to triggers in ME, and add a mission start trigger called `Load Config`
2. Add a Do-Script action with the following text: `dofile(lfs.writedir() .. [[Scripts\[YourRepository]\Config\Config.lua]])`
3. Repeat and add another mission start trigger called `Load MSF`.
4. Add a Do-Script action with the following text: `dofile(lfs.writedir() .. [[Scripts\[YourRepository]\MSF.lua]])`

Your mission will initialize MSF and all of your user scripts dynamically, meaning you can change code without having to
add your script to the mission again.

## DCS Sanitation (Mandatory)
To execute code on the mission, `MissionScripting.lua` must not be sanitized. **You must be careful when downloading
missions from other users to prevent unwanted code execution**.

1. Navigate to `[DCS installation]\Scripts\MissionScripting.lua`
2. Adjust the file to no longer sanitize by adding comments. This is necessary to allow MSF to operate the File System.

```lua
do
 --sanitizeModule('os')
 --sanitizeModule('io')
 --sanitizeModule('lfs')
 --require = nil
 --loadlib = nil
end
```

## Set Config Options (Mandatory)
MSF needs to know a couple of things. Inside your project directory, there is a `Config` directory. Inside is 
`.Config.lua`.

1. Copy the file into a new file called `Config.lua` in the same directory.
2. Follow all the instructions within.
3. If you want to, you can delete the `.gitignore` file to add your `Config.lua` back to tracking. Add whatever you want
into your config. You can add new enumerators, secrets, etc.

## Add MSF Hooks (Optional)
MSF has hooks to interact in the Net environment. MSF will also automatically initialize user hooks.
To do this, you must have added Lua to your path.

**Warning: If you are working out of multiple MSF projects, this function will overwrite or may be overwritten by
another hook generated by MSF! If both of your projects are up-to-date with MSF, this will not be an issue. Only the
core scripts in the hook would be changed during DCS startup depending on which files are loaded first.**

1. Open terminal in your project directory.
2. Run `lua5.1 MSF.lua add hooks`.
3. If this fails, make sure to have a `Hooks` directory inside `[username]\Saved Games\DCS.[version]\Scripts\`

## Adding Modules From Other Developers
This is the whole reason this framework exists. Instead of including every Module into the framework, you can pick and
choose what you want. For this to work, you must have added lua to your path. MSF.lua can be executed from the command
line and has a number of useful functions. All commands can be executed from your project directory.

1. Run: `lua5.1 MSF.lua list -a` to list the available repositories.
2. Run: `lua5.1 MSF.lua add Persist` to add the Persist module to your project.

You now have the Persist module added to your project. Refer to the individual repository for any documentation.

## Updating Modules From Other Developers

1. Run: `lua5.1 MSF.lua update -i Persist` Persist used as an example.

or

2. Run: `lua5.1 MSF.lua update -a` to update all modules in your project.

## Other Command-Line Functions

1. Run: `lua5.1 MSF.lua help` to see other things you can do.

# Your First Module
The only folders you need to be concerned about are `Modules\User` and `Modules\User\Hooks`.
MSF will add all scripts in these folders automatically into the correct place.

1. Start by deleting the `.gitignore` file present. This is for development purposes on the MSF development branch.
2. Add a new file in `Modules\User` called `Test.lua`
3. MSF is object-oriented, so you can take advantage of this by inheriting the base class.

   Here is example code:

```lua
-- Create an object called TEST
TEST = {
   -- Define the ClassName (You need to include this.)
   ClassName = 'TEST'
}

-- Instantiation Function
function TEST:New()
   -- Inherit Base (This includes many scheduler, event, and log functions for your class).
   local self = BASE:Inherit(self, BASE:New())

   -- Handle Birth Events (Very similar to MOOSE)
   self:HandleEvent(ENUMS.EVENTS.Birth, self.OnEventBirth)

   -- Add a listener on port 100 with self.OnEventChat as callback function.
   self:AddListener(100, self.OnEventChat)

   -- Return the new object.
   return self
end

-- Callback function for Birth Events
function TEST:OnEventBirth(Event)
   -- If no PlayerName, stop function.
   if not Event.IniPlayerName then return end

   -- IniUnit is the Unit wrapper object in the event.
   local Unit = Event.IniUnit

   -- UCID can be found from
   local UCID = Unit:GetUCID()

   -- You could do something more with this, if you wanted to handle only units that were not players.
   if not UCID then return end

   -- Log an info event in DCS log.
   self:Info(UCID)

   -- Does not return anything because this is a callback function.
end

-- Callback function for Chat Events
function TEST:OnEventChat(Message)
   -- Log the message.
   self:Info(Message)
end

-- Create a new instance of your class.
TEST = TEST:New()
```

You should get the following output in your DCS.log, obviously with your UCID instead. The log is very helpful in
pointing out which script file this is logging from.

Here is the output:

`2023-01-27 23:09:49.183 INFO    SCRIPTING (Main): TEST: 1773b351456bfa54ccd48gh0b77c024`

# Your First Hook Module
Hooks behave very differently from the mission modules. These are loaded only once when DCS starts. If you make any 
changes, you will have to restart DCS. The process is mostly the same as adding normal mission modules.

1. Start again by deleting the `.gitignore` file in `Modules\User\Hooks`.
2. Add a new file in `Modules\User\Hooks` called `Test.lua`.
3. The process is much the same as before, but let's do something interesting such as bridging chats to the mission 
environment.
   
   Here is example code:

```lua
-- Create an object called TEST. This is confusing, but will not interfere with our other TEST
-- object in mission because they are two separate environments. Lets set-up the communication
-- between these two.
TEST = {
   -- Define the ClassName (You need to include this.)
   ClassName = 'TEST'
}

-- Instantiation Function
function TEST:New()
   -- Inherit Base (This includes log functions for your class).
   local self = BASE:Inherit(self, BASE:New())

   -- Lets be smart and only start this hook when a mission start event happens.
   self:HandleEvent('Load', self.OnEventMissionLoad)

   -- Return the new object.
   return self
end

-- Start the hook
function TEST:Start()
   -- Now we should Handle Chat events, because the correct miz is loaded.
   self:HandleEvent('Chat', self.OnEventChat)
end

-- Callback function for mission start events. Executed only when the miz is done loading.
function TEST:OnEventMissionLoad(Event)
   -- The mission name from the Event
   local MissionName = Event.MissionName

   -- If the mission is not named 'MSF' then ignore and don't continue execution any longer
   if not MissionName == 'MSF' then return end

   -- The correct miz is loaded, start the hook
   self:Start()
end

-- Callback function for chat events.
function TEST:OnEventChat(Event)
   -- The message from the player chat.
   local Message = Event.Message

   -- Pipes the message string to a server on port 100.
   self:PipeUDP(Message, 100)
end

-- Create a new instance of your class.
TEST = TEST:New()
```

You will remember in our TEST user module that we added a listener on port 100. This is the output in the DCS.log when
the listener receives a player chat.

Here is the output:

`2023-01-28 01:25:49.075 INFO    SCRIPTING (Main): TEST: "Hey I am a message sent by a player"`

# Documentation
You will find documentation for each module within this repository in their respective `.md` file. Thanks for using MSF,
if you have any questions, please DM me on discord: `West#9009`!

# Attributions

1. [Lua 5.1.5](https://www.lua.org/)
2. [LuaFileSystem (LFS)](https://github.com/lunarmodules/luafilesystem)
